<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="index.css" media="screen" />
    <title>Pharma LRP</title>
  </head>
  <body>
    <hr>
    <h3>
      Company Information
    </h3>
    <table id="companyInfo">
      <tr>
        <td>Starting Year</td>
        <td> <input id="startYear" type="number" value="2017"> </td>
      </tr>
      <tr>
        <td>Starting Cash</td>
        <td class="right"> <input id="startCash" type="number" class="right"></td>
      </tr>
    </table>
    <br>
    <button onclick="yearDisplay();cashStartDisplay()">Submit</button>
    <br>
    <hr>
    <h3>
      Development Phases
    </h3>
    <table id="preclinicalPhases">
      <tr>
        <th col>Preclinical Phase</th>
        <th col>Cost / period</th>
      </tr>
      <tr>
        <td>Discovery</td>
        <td> <input class="right" id="discoveryCost" type="number"> </td>
      </tr>     <tr>
        <td>Preclinical</td>
        <td> <input class="right"  id="preclinicalCost" type="number"> </td>
      </tr>
    </table>
    <br>
    <table id="clinicalPhases">
      <tr>
        <th col>Clinical Phase</th>
        <th col>Patients</th>
        <th col>Cost / patient</th>
        <th col>Total Trial Cost</th>
      </tr>
      <tr>
        <td>Phase 1</td>
        <td> <input class="right "id="phase1Patients" type="number"> </td>
        <td> <input class="right "id="phase1PatientCost" type="number"> </td>
        <td> <p id="phase1Total" class="output"> </td>
      </tr>   
      <tr>
        <td>Phase 2</td>
        <td> <input class="right "id="phase2Patients" type="number"> </td>
        <td> <input class="right "id="phase2PatientCost" type="number"> </td>
        <td> <p id="phase2Total" class="output"> </td>
      </tr>   
      <tr>
        <td>Phase 3</td>
        <td> <input class="right "id="phase3Patients" type="number"> </td>
        <td> <input class="right "id="phase3PatientCost" type="number"> </td>
        <td> <p id="phase3Total" class="output"> </td>
      </tr>   
   </table>
    <br>
    <button onclick="developmentPhases()">Submit</button>
    <br>
    <hr>
    <h3>
      Programs
    </h3>
    <table id="programs">
      <tr>
        <th col>Program Name</th>
      </tr>
      <tr>
        <td> <input id="newProgram" type="text" placeholder="New Program" class="programs"></td>
      </tr>
    </table>
    <br>
    <button onclick="addProgram()">Add Program</button>
    <p id="newProgramError" class="error"></p>
    <hr>
    <h3>
      Program Development Timeline
    </h3>
    <table id="programTimeline">
      <tr>
        <th col>Program</th>
        <th col id="programTimelineYear0Label"> </th>
        <th col id="programTimelineYear1Label"> </th>
        <th col id="programTimelineYear2Label"> </th>
        <th col id="programTimelineYear3Label"> </th>
        <th col id="programTimelineYear4Label"> </th> 
      </tr>
    </table>
    <br>
    <button onclick="devPhaseCount()">Submit</button>
    <hr>
    <h3>
      Employee Expenses
    </h3>
    <table id="FTEs">
      <tr>
        <th col>Department</th>
        <th col>Fully-loaded cost</th>
        <th col id="FTEsYear0Label"> </th>
        <th col id="FTEsYear1Label"> </th>
        <th col id="FTEsYear2Label"> </th>
        <th col id="FTEsYear3Label"> </th>
        <th col id="FTEsYear4Label"> </th>
     </tr>
     <tr>
        <td> Research and Development </td>
        <td> <input id="rdFTECost" type="number" class="right"> </td>
        <td> <input id="rdYear0FTECount" type="number" class="right"> </td>
        <td> <input id="rdYear1FTECount" type="number" class="right"> </td>
        <td> <input id="rdYear2FTECount" type="number" class="right"> </td>
        <td> <input id="rdYear3FTECount" type="number" class="right"> </td>
        <td> <input id="rdYear4FTECount" type="number" class="right"> </td>
     </tr>
     <tr>
        <td> General and Admin </td>
        <td> <input id="gaFTECost" type="number" class="right"> </td>
        <td> <input id="gaYear0FTECount" type="number" class="right"> </td>
        <td> <input id="gaYear1FTECount" type="number" class="right"> </td>
        <td> <input id="gaYear2FTECount" type="number" class="right"> </td>
        <td> <input id="gaYear3FTECount" type="number" class="right"> </td>
        <td> <input id="gaYear4FTECount" type="number" class="right"> </td>
    </tr>
    </table>
    <br>
    <button onclick="FTECost()">Submit</button>
    <hr>
    <h3>
      Other Expenses
    </h3>
    <table id="otherExpense">
      <tr>
        <th col>Item</th>
        <th id="otherExpenseYear0Label"> </th>
        <th col id="otherExpenseYear1Label" class="otherExpense"> </th>
        <th col id="otherExpenseYear2Label" class="otherExpense"> </th>
        <th col id="otherExpenseYear3Label" class="otherExpense"> </th>
        <th col id="otherExpenseYear4Label" class="otherExpense"> </th>
      </tr>
      <tr>
        <td> <input type="text" placeholder="e.g. CapEx"></td>
        <td> <input type="number"> </td>
        <td> <input type="number"> </td>
        <td> <input type="number"> </td>
        <td> <input type="number"> </td>
        <td> <input type="number"> </td>
      </tr>
    </table>
    <br>
    <button onclick="addRow('otherExpense')">Add</button>
    <br>
    <hr>
    <h3>
      Financings
    </h3>
    <table id="financings">
      <tr>
        <th>Name</th>
        <th>Amount</th>
        <th>Period</th>
      </tr>
      <tr>
        <td> <input type="text"> </td>
        <td> <input type="number" class="right"> </td>
        <td> <input type="number" class="right"> </td>
      </tr>
    </table>
    <br>
    <button onclick="addRow('financings')">Add</button>
    <hr>
    <h3>
      Financial Results
    </h3>
    <table id="financialResults">
      <tr>
        <th col id="resultItems">Item </th>
        <th col id="financialResultsYear0Label"> </th>
        <th col id="financialResultsYear1Label"> </th>
        <th col id="financialResultsYear2Label"> </th>
        <th col id="financialResultsYear3Label"> </th>
        <th col id="financialResultsYear4Label"> </th>
      </tr>
      <tr>
        <td> Beginning Cash </td>
        <td> <p id="begCash" type="number" class="output"> </td>
        <td> <p id="begCashYear2" type="number" class="output"</td>
        <td> <p id="begCashYear3" type="number" class="output"</td>
        <td> <p id="begCashYear4" type="number" class="output"</td>
        <td> <p id="begCashYear5" type="number" class="output"</td>
      </tr>
      <tr>
        <td> Revenue </td>
        <td> <input id="yearOneRev" type="number" class="right"></td>
        <td> <input id="yearTwoRev" type="number" class="right"</td>
        <td> <input id="yearThreeRev" type="number" class="right"></td>
        <td> <input id="yearFourRev" type="number" class="right"</td>
        <td> <input id="yearFiveRev" type="number" class="right"></td>
      </tr>
      <tr>
        <td> Expenses: </td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
      </tr>
      <tr>
        <td> Program Expense </td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
      </tr>
      <tr>
        <td> Headcount Expense </td>
        <td> <p id="year0FTECost" class="output"></td>
        <td> <p id="year1FTECost" class="output"></td>
        <td> <p id="year2FTECost" class="output"></td>
        <td> <p id="year3FTECost" class="output"></td>
        <td> <p id="year4FTECost" class="output"></td>
     </tr>
      <tr>
        <td> Other Expense </td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
        <td> </td>
      </tr>
      <tr>
        <td> Ending Cash </td>
        <td> <p id="endCashYear1" class="output"> </p> </td>
        <td> <p id="endCashYear2" class="output"></td>
        <td> <p id="endCashYear3" class="output" type="number"></td>
        <td> <p id="endCashYear4" class="output" type="number"></td>
        <td> <p id="endCashYear5" class="output" type="number"></td>
      </tr>
    </table>
    <br>
    <button id="calculate-simulation-button" type="button">Calculate</button>
    <br>

    <script>
     
      const calculateSimulationButton = document.getElementById('calculate-simulation-button');
      const yearOneCash = document.getElementById('startCash');
      const Revenue = [document.getElementById('yearOneRev'), 
        document.getElementById('yearTwoRev'), 
        document.getElementById('yearThreeRev'), 
        document.getElementById('yearFourRev'), 
        document.getElementById('yearFiveRev')];
      const Expenses = [document.getElementById('yearOneExp'), 
        document.getElementById('yearTwoExp'), 
        document.getElementById('yearThreeExp'), 
        document.getElementById('yearFourExp'), 
        document.getElementById('yearFiveExp')];

      calculateSimulationButton.onclick = () => {
        let httpRequestData = {
          begCash: Number(startCash.value),
          Revenue: [Number(yearOneRev.value),
            Number(yearTwoRev.value),
            Number(yearThreeRev.value),
            Number(yearFourRev.value),
            Number(yearFiveRev.value)],
          Expenses: [Number(yearOneExp.value),
            Number(yearTwoExp.value),
            Number(yearThreeExp.value),
            Number(yearFourExp.value),
            Number(yearFiveExp.value)],
        };

        fetch('api/calculate', {
          method: 'post',
          body: JSON.stringify(httpRequestData),
        }).then((response) => {
          return response.json();
        }).then((httpResponseData) => {
          let resultText;
          if (httpResponseData.result !== undefined) {
            resultText = httpResponseData.result;
            for (yearIndex = 1; yearIndex<6; yearIndex ++) {
              if (yearIndex === 1) {
                document.getElementById("endCashYear"+yearIndex).innerHTML = numberWithCommas(resultText[yearIndex-1]);
              } else {
                document.getElementById("begCashYear"+yearIndex).innerHTML = numberWithCommas(resultText[yearIndex-2]);
                document.getElementById("endCashYear"+yearIndex).innerHTML = numberWithCommas(resultText[yearIndex-1]);
              }
            }
            } else {
            resultText = "Something went wrong :(";
            }
          resultParagraph.innerText = resultText;
          });
      } 

//"need to determine global vs local variables. I need model years in other places (checking financings year, etc)"
var modelYears = [] 

//"Function needs to be updated if years out is greater than 5"
      function yearDisplay() {
        //array yearDisplayArray holds all HTML tables where years needs to be displayed
        yearDisplayArray = ['financialResults','otherExpense','FTEs','programTimeline']
        startYear = parseInt(document.getElementById('startYear').value);
        for (x=0; x<yearDisplayArray.length; x++) {
          for (y=0; y<5; y++) {
            modelYears[y] = startYear + y;
            document.getElementById(yearDisplayArray[x]+'Year'+y+'Label').innerHTML = startYear + y;
            }
          }
        }

      function cashStartDisplay() {
        number = +document.getElementById("startCash").value;
        document.getElementById("begCash").innerHTML = numberWithCommas(number);
        document.getElementById("startCash").innerHTML = numberWithCommas(number);
      }

      function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

//"Think through how I can make this into a function"
      function developmentPhases() {
        discoveryCost = document.getElementById('discoveryCost').value;
        preclinicalCost = document.getElementById('preclinicalCost').value;
        //"Phase 1 costs //
        phase1Patients = document.getElementById('phase1Patients').value;
        phase1PatientCost = document.getElementById('phase1PatientCost').value;
        phase1Total = phase1Patients * phase1PatientCost
        document.getElementById('phase1Total').innerHTML = numberWithCommas(phase1Total);
        //"Phase 2 costs //
        phase2Patients = document.getElementById('phase2Patients').value;
        phase2PatientCost = document.getElementById('phase2PatientCost').value;
        phase2Total = phase2Patients * phase2PatientCost
        document.getElementById('phase2Total').innerHTML = numberWithCommas(phase2Total);
        //"Phase 3 costs //
        phase3Patients = document.getElementById('phase3Patients').value;
        phase3PatientCost = document.getElementById('phase3PatientCost').value;
        phase3Total = phase3Patients * phase3PatientCost
        document.getElementById('phase3Total').innerHTML = numberWithCommas(phase3Total);
      }

      programList = []
      programName = document.getElementById("newProgram");
      displayProgramList = document.getElementById("displayProgram");

      function addProgram() {
        if (programName.value === "") {
          newProgramError = "*Please enter a program name"
          document.getElementById("newProgramError").innerHTML = newProgramError
          } else {
          programList.push(programName.value);
          displayProgram();
          programDevPhases();
          document.getElementById("newProgramError").innerHTML = "";
          }
      }
      
      function displayProgram() {
        // Clear our fields
        programName.value = "";
  
        // Show our output
        programTable = document.getElementById("programs");
        var row = programTable.insertRow(-1);
        var cell = row.insertCell(-1);
        cell.appendChild(document.createTextNode(programList[programList.length - 1]));
        }

      function programDevPhases() {
        for (x=programList.length-1; x<programList.length; x++) {
            var table = document.getElementById('programTimeline');
            var row = table.insertRow(table.rows.length);
            for (i=0; i<table.rows[0].cells.length; i++) {
              if (i===0) {
                createCell(row.insertCell(i), i, 'row');
                document.getElementById("program"+x).innerHTML = programList[x];
              } else {
                createDevPhaseCell(row.insertCell(i), 'row');
              }
            }
          }
        }

      function createCell(cell, text, style) {
        var div = document.createElement("program"+x), // create DIV element
          txt = document.createTextNode(text); // create text node
        div.appendChild(txt);                    // append text node to the DIV
        div.setAttribute('class', style);        // set DIV class attribute
        div.setAttribute('className', style);    // set DIV class attribute for IE (?!)
        div.setAttribute('id', "program"+x);
        cell.appendChild(div);                   // append DIV to the table cell
}

      function createDevPhaseCell(cell, style) {
        var div = document.createElement('select');
        const devPhases = [
          {
            id: "discovery",
            name: "Discovery"
          },
          {
            id: "preclinical",
            name: "Prelinical"
          },
          {
            id: "phase1",
            name: "Phase 1"
          },
          {
            id: "phase2",
            name: "Phase 2"
          },
          {
            id: "phase3",
            name: "Phase 3"
          },
          {
            id: "na",
            name: "N/A"
          }
          ]

        for (x=0; x<Object.keys(devPhases).length; x++) {
          devPhaseOption = document.createElement('option');
          attribute = document.createAttribute('id');
          devPhaseOption.innerHTML = devPhases[x]['name'];
          attribute.value = devPhases[x]['id'];
          div.appendChild(devPhaseOption);
          devPhaseOption.setAttributeNode(attribute);
        }
        div.type = "select";
        cell.appendChild(div);
      }

      function devPhaseCount() {
        var table = document.getElementById("programTimeline");
        var discoveryCount = 0;
        for (var x=0, row; row = table.rows[x]; x++) {
          for (var y=0, col; col = row.cells[y]; y++) {
            selectedPhase = document.querySelectorAll("select");
            for (var z=0; z<selectedPhase.length; z++) {
            test = selectedPhase[0].selectedOptions.value;
            if (test === "Discovery") {
              discoveryCount ++
            };
          }
        }
        console.log(selectedPhase);
      }
    }


//"FTE functions"

      function FTECost() {
        var FTECost = {
          "rd": [],
          "ga": [],
          "total": []
          }
        var FTEClass = ["rd", "ga"];
        for (x=0; x<FTEClass.length; x++) {
          for (y=0; y<5; y++) {
            rate = document.getElementById(FTEClass[x]+"FTECost").value;
            FTECount = document.getElementById(FTEClass[x]+"Year"+y+"FTECount").value;
            FTECost[FTEClass[x]][y] = rate * FTECount
          }
        }
        for (z=0; z<5; z++) {
          FTECost["total"][z] = FTECost["rd"][z] + FTECost["ga"][z];
          document.getElementById("year"+z+"FTECost").innerHTML = numberWithCommas(FTECost["total"][z]);
        }       
        console.log(FTECost);
      }

//"Other Expenses Functions"

      function addRow(table) {
        var table = document.getElementById(table);
        var row = table.insertRow(table.rows.length);
        for (i=0; i<table.rows[0].cells.length; i++) {
          if (i === 0) {
            var div = document.createElement("input"),
              txt = document.createTextNode(i);
            div.appendChild(txt);
            div.type = "text";
            row.insertCell(i).appendChild(div);
            } else {
            var div = document.createElement("input"),
              txt = document.createTextNode(i);
            div.appendChild(txt);
            div.type = "number";
            div.className = "right";
            row.insertCell(i).appendChild(div);
            }
          }
       }

      function calculateOtherExpense() {
        table = document.getElementById("otherExpense");
        var otherExpense = [];
        otherExpenseRow = table.rows;
        for (x = table.rows.length -1 ; x < table.rows.length; x++) {
          cell = otherExpenseRow[x].cells;
          for (y = 0; y < cell.length; y++) {
            otherExpenseItem = document.querySelectorAll("td").value
            otherExpense.push(otherExpenseItem);
            console.log(otherExpense);
          }
        }
      }

//"Financing functions

      function yearCheck() {

      }
    </script>
</html>
